<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å“å‡ºã—ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    :root { --magenta: #e81cff; --cyan: #00f0ff; --dark: #111; }
    
    * { 
      box-sizing: border-box; margin: 0; padding: 0; 
      user-select: none; 
      -webkit-user-select: none; 
      -webkit-touch-callout: none; /* é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼é˜²æ­¢ */
    }
    
    body { font-family: sans-serif; background: #000; overflow: hidden; height: 100vh; color: #fff; touch-action: none; }

    /* ã‚«ãƒ¡ãƒ©ã¨å†™çœŸã®è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼ */
    #cameraVideo, #photoView { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
    #cameraVideo { z-index: 1; display: none; }
    #photoView { z-index: 2; filter: brightness(0.85); display: none; }
    #touchArea { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; display: none; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      position: absolute; top: 0; left: 0; width: 100%;
      padding: 20px 20px 40px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
      text-align: center; pointer-events: none; z-index: 10;
    }
    .header h1 { font-size: 18px; font-weight: 900; }
    .header p { font-size: 12px; font-weight: bold; color: #ddd; margin-top: 4px; }

    /* ãƒãƒƒã‚¸ */
    .badge {
      position: absolute; transform: translate(-50%, -50%);
      background: var(--magenta); color: #fff;
      width: 48px; height: 48px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; font-weight: 900; border: 3px solid #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      transition: transform 0.1s; cursor: pointer; z-index: 5;
    }
    .badge:active { transform: translate(-50%, -50%) scale(0.9); }
    .badge.checked { background: #4ade80; color: #064e3b; border-color: #fff; }

    /* ãƒœãƒˆãƒ ãƒãƒ¼ */
    .bottom-bar {
      position: absolute; bottom: 0; left: 0; width: 100%;
      padding: 40px 10px 30px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      display: flex; flex-direction: column; gap: 10px; z-index: 10;
    }
    .row { display: flex; gap: 10px; width: 100%; }
    .btn {
      flex: 1; padding: 14px; border-radius: 12px; border: none;
      font-size: 14px; font-weight: 900; cursor: pointer; text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .btn-main { background: #fff; color: var(--dark); }
    .btn-sub { background: #333; color: #fff; }
    .btn-action { background: var(--cyan); color: var(--dark); }
    .btn-alert { background: #ef4444; color: #fff; }

  </style>
</head>
<body>

  <video id="cameraVideo" autoplay muted playsinline></video>
  <img id="photoView" src="">
  <div id="touchArea"></div>

  <div class="header">
    <h1 id="headerTitle">ğŸ“¸ å£²ã‚Šå ´ãƒã‚§ãƒƒã‚¯</h1>
    <p id="headerSub">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦æ£šã‚’æ’®å½±ã—ã¦ãã ã•ã„</p>
  </div>

  <div class="bottom-bar" id="controlsCamera" style="display: none;">
    <div class="row">
      <button class="btn btn-alert" id="cancelBtn">âœ– ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-main" id="shutterBtn">â­•ï¸ æ’®å½±ã™ã‚‹</button>
    </div>
  </div>

  <div class="bottom-bar" id="controlsPhoto" style="display: none;">
    <div class="row">
      <button class="btn btn-sub" id="prevBtn">â—€ å‰ã®æ£š</button>
      <span id="pageIndicator" style="color:#fff; align-self:center; font-weight:bold; font-size:14px; width: 60px; text-align:center;">1 / 1</span>
      <button class="btn btn-sub" id="nextBtn">æ¬¡ã®æ£š â–¶</button>
    </div>
    <div class="row">
      <button class="btn btn-main" id="modeBtn">ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰ã¸</button>
      <button class="btn btn-action" id="addPhotoBtn">ğŸ“¸ æ¬¡ã®æ£šã‚’æ’®ã‚‹</button>
    </div>
    <div class="row">
      <button class="btn btn-alert" id="resetBtn">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

  <script>
    // ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®é•·æŠ¼ã—ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ï¼‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å®Œå…¨ã«å°å°
    window.oncontextmenu = function(e) {
      e.preventDefault();
      e.stopPropagation();
      return false;
    };

    const STORAGE_KEY = 'shinadashi_data';
    const MIN_DISTANCE = 55; // ãƒ”ãƒ³ãŒé‡ãªã‚‰ãªã„ãŸã‚ã®æœ€å°è·é›¢

    const cameraVideo = document.getElementById('cameraVideo');
    const photoView = document.getElementById('photoView');
    const touchArea = document.getElementById('touchArea');
    const headerTitle = document.getElementById('headerTitle');
    const headerSub = document.getElementById('headerSub');
    
    const controlsCamera = document.getElementById('controlsCamera');
    const controlsPhoto = document.getElementById('controlsPhoto');
    const pageIndicator = document.getElementById('pageIndicator');
    const modeBtn = document.getElementById('modeBtn');

    let stream = null;
    let isCheckMode = false;
    let appData = { photos: [], currentIndex: -1 };

    // --- èµ·å‹•ã¨å¾©æ—§å‡¦ç† ---
    function init() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          appData = JSON.parse(saved);
        }
      } catch (e) {
        // ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ãŸå ´åˆã¯è‡ªå‹•ã§ãƒªã‚»ãƒƒãƒˆ
        localStorage.removeItem(STORAGE_KEY);
        appData = { photos: [], currentIndex: -1 };
      }

      // ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«ã‚ã‚Œã°å†™çœŸè¡¨ç¤ºã€ãªã‘ã‚Œã°ã‚«ãƒ¡ãƒ©èµ·å‹•
      if (appData && appData.photos && appData.photos.length > 0) {
        appData.currentIndex = appData.photos.length - 1;
        renderPhoto();
      } else {
        appData = { photos: [], currentIndex: -1 };
        openCamera();
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
      } catch (e) {
        alert('ä¿å­˜å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');
      }
    }

    // --- ã‚«ãƒ¡ãƒ©é–¢é€£ ---
    async function openCamera() {
      photoView.style.display = 'none';
      touchArea.style.display = 'none';
      controlsPhoto.style.display = 'none';
      cameraVideo.style.display = 'block';
      controlsCamera.style.display = 'flex';
      headerTitle.textContent = 'ğŸ“¸ æ’®å½±ãƒ¢ãƒ¼ãƒ‰';
      headerSub.textContent = 'å•†å“ã‚’æ­£é¢ã‹ã‚‰æ’®å½±ã—ã¦ãã ã•ã„';

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        cameraVideo.srcObject = stream;
      } catch (err) {
        alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      cameraVideo.style.display = 'none';
      controlsCamera.style.display = 'none';
    }

    document.getElementById('shutterBtn').addEventListener('click', () => {
      // æœ€å¤§1280pxã§é«˜ç”»è³ªã«æ’®å½±
      const MAX_SIZE = 1280;
      let w = cameraVideo.videoWidth || 640;
      let h = cameraVideo.videoHeight || 480;
      
      if (w > MAX_SIZE || h > MAX_SIZE) {
        if (w > h) { h = Math.floor(h * (MAX_SIZE / w)); w = MAX_SIZE; }
        else { w = Math.floor(w * (MAX_SIZE / h)); h = MAX_SIZE; }
      }

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(cameraVideo, 0, 0, w, h);
      const base64 = canvas.toDataURL('image/jpeg', 0.85);

      const newPhoto = { id: Date.now(), image: base64, badges: [] };
      appData.photos.push(newPhoto);
      appData.currentIndex = appData.photos.length - 1;
      
      saveData();
      stopCamera();
      renderPhoto();
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      if (appData.photos.length > 0) {
        stopCamera();
        renderPhoto();
      } else {
        alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ’®å½±ã—ã¦ãã ã•ã„ã€‚');
      }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(STORAGE_KEY);
        appData = { photos: [], currentIndex: -1 };
        openCamera();
      }
    });

    // --- å†™çœŸã¨ãƒãƒƒã‚¸æç”» ---
    function renderPhoto() {
      touchArea.innerHTML = ''; 
      const currentPhoto = appData.photos[appData.currentIndex];
      
      photoView.src = currentPhoto.image;
      photoView.style.display = 'block';
      touchArea.style.display = 'block';
      controlsPhoto.style.display = 'flex';
      
      pageIndicator.textContent = `${appData.currentIndex + 1} / ${appData.photos.length}`;
      updateHeader();

      currentPhoto.badges.forEach(b => createBadgeElement(b));
    }

    function updateHeader() {
      if (isCheckMode) {
        headerTitle.textContent = 'ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰';
        headerSub.textContent = 'é•·æŠ¼ã—ã§å‰Šé™¤ / ã‚¿ãƒƒãƒ—ã§âœ“';
      } else {
        headerTitle.textContent = 'ğŸ“ ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰';
        headerSub.textContent = 'ã‚¿ãƒƒãƒ—ã§ã‚«ã‚¦ãƒ³ãƒˆUP / é•·æŠ¼ã—ã§å‰Šé™¤';
      }
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (appData.currentIndex > 0) { appData.currentIndex--; renderPhoto(); }
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (appData.currentIndex < appData.photos.length - 1) { appData.currentIndex++; renderPhoto(); }
    });
    document.getElementById('addPhotoBtn').addEventListener('click', openCamera);

    modeBtn.addEventListener('click', () => {
      isCheckMode = !isCheckMode;
      modeBtn.style.background = isCheckMode ? 'var(--cyan)' : '#fff';
      modeBtn.textContent = isCheckMode ? 'âœ… ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã¸æˆ»ã‚‹' : 'ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰ã¸';
      updateHeader();
    });

    // --- ãƒãƒƒã‚¸ä½œæˆã¨æ“ä½œ ---
    touchArea.addEventListener('click', (e) => {
      if (isCheckMode || e.target !== touchArea) return;

      const currentPhoto = appData.photos[appData.currentIndex];
      
      // é‡ãªã‚Šé˜²æ­¢
      const isTooClose = currentPhoto.badges.some(b => {
        const dx = b.x - e.clientX;
        const dy = b.y - e.clientY;
        return Math.sqrt(dx*dx + dy*dy) < MIN_DISTANCE;
      });
      if (isTooClose) return;

      const newBadge = { id: Date.now(), x: e.clientX, y: e.clientY, count: 1, checked: false };
      currentPhoto.badges.push(newBadge);
      saveData();
      createBadgeElement(newBadge);
    });

    function createBadgeElement(badgeData) {
      const badge = document.createElement('div');
      badge.className = `badge ${badgeData.checked ? 'checked' : ''}`;
      badge.style.left = badgeData.x + 'px';
      badge.style.top = badgeData.y + 'px';
      badge.textContent = badgeData.checked ? 'âœ“' : badgeData.count;

      // é•·æŠ¼ã—å‰Šé™¤å‡¦ç†ï¼ˆã‚¿ãƒƒãƒã¨ãƒã‚¦ã‚¹ä¸¡å¯¾å¿œï¼‰
      let pressTimer;
      const startPress = () => {
        pressTimer = setTimeout(() => {
          if(confirm('ã“ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
            const currentPhoto = appData.photos[appData.currentIndex];
            currentPhoto.badges = currentPhoto.badges.filter(b => b.id !== badgeData.id);
            saveData();
            badge.remove();
          }
        }, 500);
      };
      const cancelPress = () => clearTimeout(pressTimer);

      badge.addEventListener('touchstart', startPress, { passive: true });
      badge.addEventListener('touchend', cancelPress, { passive: true });
      badge.addEventListener('touchmove', cancelPress, { passive: true });
      badge.addEventListener('mousedown', startPress);
      badge.addEventListener('mouseup', cancelPress);
      badge.addEventListener('mouseleave', cancelPress);

      // ã‚¿ãƒƒãƒ—å‡¦ç†
      badge.addEventListener('click', (e) => {
        e.stopPropagation();
        const currentPhoto = appData.photos[appData.currentIndex];
        const targetBadge = currentPhoto.badges.find(b => b.id === badgeData.id);
        if(!targetBadge) return;

        if (isCheckMode) {
          targetBadge.checked = !targetBadge.checked;
          badge.classList.toggle('checked');
          badge.textContent = targetBadge.checked ? 'âœ“' : targetBadge.count;
        } else {
          targetBadge.count = targetBadge.count >= 7 ? 1 : targetBadge.count + 1;
          badge.textContent = targetBadge.count;
        }
        saveData();
      });

      touchArea.appendChild(badge);
    }

    init();
  </script>
</body>
</html>