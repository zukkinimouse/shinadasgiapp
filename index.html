<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å“å‡ºã—ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box; margin: 0; padding: 0;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: #000; color: #fff;
      font-family: -apple-system, 'Helvetica Neue', sans-serif;
    }

    #main-canvas {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      display: block;
      touch-action: none;
    }

    #camera-video {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      display: none;
      z-index: 1;
    }

    #header {
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 10;
      padding: 20px 16px 48px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent);
      text-align: center;
      pointer-events: none;
    }
    #header h1 { font-size: 18px; font-weight: 900; }
    #header p  { font-size: 12px; color: #ccc; margin-top: 4px; }

    #bottom-bar, #ctrl-camera {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 10;
      padding: 48px 12px 28px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      flex-direction: column;
      gap: 10px;
      display: none;
    }
    .row { display: flex; gap: 10px; align-items: center; }
    .btn {
      flex: 1; padding: 15px 8px;
      border: none; border-radius: 14px;
      font-size: 14px; font-weight: 900;
      cursor: pointer;
      -webkit-appearance: none;
    }
    .btn-white { background: #fff; color: #111; }
    .btn-dark  { background: #2a2a2a; color: #fff; }
    .btn-cyan  { background: #00f0ff; color: #111; }
    .btn-red   { background: #ef4444; color: #fff; }
    .btn-green { background: #4ade80; color: #064e3b; }
    #page-indicator {
      color: #fff; font-size: 14px; font-weight: bold;
      min-width: 60px; text-align: center;
    }
  </style>
</head>
<body>

<canvas id="main-canvas"></canvas>
<video id="camera-video" autoplay muted playsinline></video>

<div id="header">
  <h1 id="h-title">ğŸ“¸ å£²ã‚Šå ´ãƒã‚§ãƒƒã‚¯</h1>
  <p id="h-sub">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦æ£šã‚’æ’®å½±ã—ã¦ãã ã•ã„</p>
</div>

<div id="ctrl-camera">
  <div class="row">
    <button class="btn btn-red"   id="btn-cancel">âœ– ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn btn-white" id="btn-shutter">â­•ï¸ æ’®å½±ã™ã‚‹</button>
  </div>
</div>

<div id="bottom-bar">
  <div class="row">
    <button class="btn btn-dark" id="btn-prev">â—€ å‰ã®æ£š</button>
    <span id="page-indicator">1 / 1</span>
    <button class="btn btn-dark" id="btn-next">æ¬¡ã®æ£š â–¶</button>
  </div>
  <div class="row">
    <button class="btn btn-white" id="btn-mode">ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰ã¸</button>
    <button class="btn btn-cyan"  id="btn-add">ğŸ“¸ æ¬¡ã®æ£šã‚’æ’®ã‚‹</button>
  </div>
  <div class="row">
    <button class="btn btn-red" id="btn-reset">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<script>
const STORAGE_KEY = 'shinadashi_v3';
const BADGE_R     = 26;
const MIN_DIST    = 55;

const canvas = document.getElementById('main-canvas');
const ctx    = canvas.getContext('2d');
const video  = document.getElementById('camera-video');

let data        = { photos: [], currentIndex: -1 };
let isCheckMode = false;
let stream      = null;
let bgImage     = null;

/* --- canvas ãƒªã‚µã‚¤ã‚º --- */
function resizeCanvas() {
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  redraw();
}
window.addEventListener('resize', resizeCanvas);

/* --- æç”» --- */
function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!bgImage) return;

  const iw = bgImage.naturalWidth, ih = bgImage.naturalHeight;
  const cw = canvas.width, ch = canvas.height;
  const scale = Math.max(cw / iw, ch / ih);
  const dw = iw * scale, dh = ih * scale;
  const dx = (cw - dw) / 2, dy = (ch - dh) / 2;

  ctx.save();
  ctx.globalAlpha = 0.85;
  ctx.drawImage(bgImage, dx, dy, dw, dh);
  ctx.restore();

  const photo = data.photos[data.currentIndex];
  if (photo) photo.badges.forEach(b => drawBadge(b));
}

function drawBadge(b) {
  const x = b.x, y = b.y, r = BADGE_R;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI * 2);
  ctx.fillStyle   = b.checked ? '#4ade80' : '#e81cff';
  ctx.fill();
  ctx.strokeStyle = '#fff';
  ctx.lineWidth   = 3;
  ctx.stroke();

  ctx.font         = `900 ${r}px -apple-system, sans-serif`;
  ctx.fillStyle    = b.checked ? '#064e3b' : '#fff';
  ctx.textAlign    = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(b.checked ? 'âœ“' : String(b.count), x, y + 1);
}

/* --- ä¿å­˜ãƒ»èª­è¾¼ --- */
function save() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  catch(e) { alert('ä¿å­˜å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚'); }
}

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed.photos) || parsed.photos.length === 0) return false;
    data = parsed;
    return true;
  } catch(e) {
    localStorage.removeItem(STORAGE_KEY);
    return false;
  }
}

/* --- å†™çœŸè¡¨ç¤º --- */
function showPhoto() {
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;

  const photo = data.photos[data.currentIndex];
  bgImage = new Image();
  bgImage.onload = redraw;
  bgImage.src = photo.image;

  document.getElementById('page-indicator').textContent =
    `${data.currentIndex + 1} / ${data.photos.length}`;
  document.getElementById('bottom-bar').style.display = 'flex';
  document.getElementById('ctrl-camera').style.display = 'none';
  updateHeader();
}

function updateHeader() {
  document.getElementById('h-title').textContent =
    isCheckMode ? 'ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰' : 'ğŸ“ ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰';
  document.getElementById('h-sub').textContent =
    isCheckMode ? 'ã‚¿ãƒƒãƒ—ã§âœ“ / é•·æŠ¼ã—ã§å‰Šé™¤' : 'ã‚¿ãƒƒãƒ—ã§ã‚«ã‚¦ãƒ³ãƒˆUP / é•·æŠ¼ã—ã§å‰Šé™¤';
}

/* --- ã‚«ãƒ¡ãƒ© --- */
async function openCamera() {
  bgImage = null;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  video.style.display = 'block';
  document.getElementById('ctrl-camera').style.display = 'flex';
  document.getElementById('bottom-bar').style.display = 'none';
  document.getElementById('h-title').textContent = 'ğŸ“¸ æ’®å½±ãƒ¢ãƒ¼ãƒ‰';
  document.getElementById('h-sub').textContent   = 'å•†å“æ£šã‚’æ­£é¢ã‹ã‚‰æ’®å½±ã—ã¦ãã ã•ã„';

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } }, audio: false
    });
    video.srcObject = stream;
  } catch(e) {
    alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}

function stopCamera() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  video.style.display = 'none';
  video.srcObject = null;
  document.getElementById('ctrl-camera').style.display = 'none';
}

document.getElementById('btn-shutter').addEventListener('click', () => {
  const MAX = 1280;
  let w = video.videoWidth || 640, h = video.videoHeight || 480;
  if (w > MAX || h > MAX) {
    if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
    else       { w = Math.round(w * MAX / h); h = MAX; }
  }
  const cv = document.createElement('canvas');
  cv.width = w; cv.height = h;
  cv.getContext('2d').drawImage(video, 0, 0, w, h);
  const img64 = cv.toDataURL('image/jpeg', 0.82);

  data.photos.push({ id: Date.now(), image: img64, badges: [] });
  data.currentIndex = data.photos.length - 1;
  save();
  stopCamera();
  showPhoto();
});

document.getElementById('btn-cancel').addEventListener('click', () => {
  if (data.photos.length > 0) { stopCamera(); showPhoto(); }
  else alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ’®å½±ã—ã¦ãã ã•ã„ã€‚');
});

document.getElementById('btn-prev').addEventListener('click', () => {
  if (data.currentIndex > 0) { data.currentIndex--; showPhoto(); }
});
document.getElementById('btn-next').addEventListener('click', () => {
  if (data.currentIndex < data.photos.length - 1) { data.currentIndex++; showPhoto(); }
});
document.getElementById('btn-add').addEventListener('click', openCamera);
document.getElementById('btn-reset').addEventListener('click', () => {
  if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
    localStorage.removeItem(STORAGE_KEY);
    data = { photos: [], currentIndex: -1 };
    bgImage = null;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    openCamera();
  }
});

const btnMode = document.getElementById('btn-mode');
btnMode.addEventListener('click', () => {
  isCheckMode = !isCheckMode;
  btnMode.className   = isCheckMode ? 'btn btn-green' : 'btn btn-white';
  btnMode.textContent = isCheckMode ? 'âœ… ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã¸æˆ»ã‚‹' : 'ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰ã¸';
  updateHeader();
  redraw();
});

/* ==============================================
   ã‚¿ãƒƒãƒå‡¦ç†ï¼ˆcanvasä¸€æœ¬åŒ–ãƒ»clickã‚¤ãƒ™ãƒ³ãƒˆä¸ä½¿ç”¨ï¼‰
============================================== */
let touchStart     = null;
let longPressTimer = null;

canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  if (e.touches.length !== 1) return;
  const t = e.touches[0];
  touchStart = { x: t.clientX, y: t.clientY };

  longPressTimer = setTimeout(() => {
    longPressTimer = null;
    handleLongPress(touchStart.x, touchStart.y);
  }, 600);
}, { passive: false });

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!touchStart || !longPressTimer) return;
  const t = e.touches[0];
  if (Math.hypot(t.clientX - touchStart.x, t.clientY - touchStart.y) > 8) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
}, { passive: false });

canvas.addEventListener('touchend', e => {
  e.preventDefault();
  if (!touchStart) return;

  // longPressTimerãŒnullãªã‚‰é•·æŠ¼ã—ç™ºç«æ¸ˆã¿ â†’ ã‚¿ãƒƒãƒ—å‡¦ç†ã—ãªã„
  if (longPressTimer === null) {
    touchStart = null;
    return;
  }
  clearTimeout(longPressTimer);
  longPressTimer = null;

  const t = e.changedTouches[0];
  const d = Math.hypot(t.clientX - touchStart.x, t.clientY - touchStart.y);
  touchStart = null;

  if (d > 10) return;
  handleTap(t.clientX, t.clientY);
}, { passive: false });

/* --- ã‚¿ãƒƒãƒ—ãƒ»é•·æŠ¼ã—å‡¦ç† --- */
function findBadge(x, y) {
  const photo = data.photos[data.currentIndex];
  if (!photo) return null;
  for (let i = photo.badges.length - 1; i >= 0; i--) {
    if (Math.hypot(photo.badges[i].x - x, photo.badges[i].y - y) <= BADGE_R + 10)
      return photo.badges[i];
  }
  return null;
}

function handleTap(x, y) {
  if (!bgImage) return;
  const photo = data.photos[data.currentIndex];
  if (!photo) return;

  const hit = findBadge(x, y);
  if (hit) {
    if (isCheckMode) {
      hit.checked = !hit.checked;
    } else {
      hit.count = hit.count >= 7 ? 1 : hit.count + 1;
    }
    save();
    redraw();
  } else if (!isCheckMode) {
    const tooClose = photo.badges.some(b => Math.hypot(b.x - x, b.y - y) < MIN_DIST);
    if (tooClose) return;
    photo.badges.push({ id: Date.now(), x, y, count: 1, checked: false });
    save();
    redraw();
  }
}

function handleLongPress(x, y) {
  const hit = findBadge(x, y);
  if (!hit) return;
  if (confirm('ã“ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    const photo = data.photos[data.currentIndex];
    photo.badges = photo.badges.filter(b => b.id !== hit.id);
    save();
    redraw();
  }
}

/* --- èµ·å‹• --- */
document.addEventListener('contextmenu', e => e.preventDefault());
resizeCanvas();

if (load()) {
  data.currentIndex = data.photos.length - 1;
  showPhoto();
} else {
  data = { photos: [], currentIndex: -1 };
  openCamera();
}
</script>
</body>
</html>
