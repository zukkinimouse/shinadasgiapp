<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å“å‡ºã—ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    :root { --magenta: #e81cff; --cyan: #00f0ff; --dark: #111; }

    *, *::before, *::after {
      box-sizing: border-box; margin: 0; padding: 0;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100%; height: 100%; overflow: hidden;
      background: #000; color: #fff;
      font-family: -apple-system, 'Helvetica Neue', sans-serif;
      touch-action: none;
    }

    /* ======= ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ ======= */
    #layer-video,
    #layer-photo,
    #layer-touch {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
    }

    #layer-video {
      z-index: 1;
      object-fit: cover;
      display: none;
    }

    #layer-photo {
      z-index: 2;
      object-fit: cover;
      filter: brightness(0.85);
      display: none;
      /* iOSã§ç”»åƒé•·æŠ¼ã—ã‚’å®Œå…¨é˜²æ­¢ */
      pointer-events: none;
    }

    #layer-touch {
      z-index: 3;
      display: none;
    }

    /* ======= ãƒ˜ãƒƒãƒ€ãƒ¼ ======= */
    #header {
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 10;
      padding: 20px 16px 48px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.85), transparent);
      text-align: center;
      pointer-events: none;
    }
    #header h1 { font-size: 18px; font-weight: 900; }
    #header p  { font-size: 12px; color: #ccc; margin-top: 4px; }

    /* ======= ãƒãƒƒã‚¸ ======= */
    .badge {
      position: fixed;
      width: 52px; height: 52px;
      border-radius: 50%;
      background: var(--magenta);
      color: #fff;
      border: 3px solid #fff;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; font-weight: 900;
      box-shadow: 0 4px 14px rgba(0,0,0,0.7);
      z-index: 5;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: transform 0.08s;
    }
    .badge.active { transform: translate(-50%, -50%) scale(0.88); }
    .badge.checked { background: #4ade80; color: #064e3b; }

    /* ======= ãƒœãƒˆãƒ ãƒãƒ¼ ======= */
    #bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 10;
      padding: 48px 12px 28px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .row { display: flex; gap: 10px; }
    .btn {
      flex: 1; padding: 15px 8px;
      border: none; border-radius: 14px;
      font-size: 14px; font-weight: 900;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      -webkit-appearance: none;
    }
    .btn-white  { background: #fff; color: #111; }
    .btn-dark   { background: #2a2a2a; color: #fff; }
    .btn-cyan   { background: var(--cyan); color: #111; }
    .btn-red    { background: #ef4444; color: #fff; }
    .btn-green  { background: #4ade80; color: #064e3b; }

    /* ======= ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ======= */
    #ctrl-camera {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 10;
      padding: 48px 12px 28px;
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    /* ======= ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ ======= */
    #page-indicator {
      align-self: center;
      font-size: 14px; font-weight: bold;
      color: #fff; min-width: 60px; text-align: center;
    }
  </style>
</head>
<body>

  <!-- ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
  <video id="layer-video" autoplay muted playsinline></video>
  <img id="layer-photo" src="" alt="">
  <div id="layer-touch"></div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div id="header">
    <h1 id="h-title">ğŸ“¸ å£²ã‚Šå ´ãƒã‚§ãƒƒã‚¯</h1>
    <p id="h-sub">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦æ£šã‚’æ’®å½±ã—ã¦ãã ã•ã„</p>
  </div>

  <!-- ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div id="ctrl-camera">
    <div class="row">
      <button class="btn btn-red" id="btn-cancel">âœ– ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-white" id="btn-shutter">â­•ï¸ æ’®å½±ã™ã‚‹</button>
    </div>
  </div>

  <!-- å†™çœŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div id="bottom-bar">
    <div class="row">
      <button class="btn btn-dark" id="btn-prev">â—€ å‰ã®æ£š</button>
      <span id="page-indicator">1 / 1</span>
      <button class="btn btn-dark" id="btn-next">æ¬¡ã®æ£š â–¶</button>
    </div>
    <div class="row">
      <button class="btn btn-white" id="btn-mode">ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰ã¸</button>
      <button class="btn btn-cyan"  id="btn-add-photo">ğŸ“¸ æ¬¡ã®æ£šã‚’æ’®ã‚‹</button>
    </div>
    <div class="row">
      <button class="btn btn-red" id="btn-reset">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>

<script>
/* =========================================================
   å®šæ•° & çŠ¶æ…‹
========================================================= */
const STORAGE_KEY = 'shinadashi_v2'; // v2ã«ã—ã¦æ—§ãƒ‡ãƒ¼ã‚¿ç«¶åˆã‚’å›é¿
const MIN_DIST    = 55; // ãƒãƒƒã‚¸é‡ãªã‚Šé˜²æ­¢è·é›¢(px)

let stream      = null;
let isCheckMode = false;
let data        = { photos: [], currentIndex: -1 };

/* =========================================================
   è¦ç´ 
========================================================= */
const layerVideo  = document.getElementById('layer-video');
const layerPhoto  = document.getElementById('layer-photo');
const layerTouch  = document.getElementById('layer-touch');
const hTitle      = document.getElementById('h-title');
const hSub        = document.getElementById('h-sub');
const ctrlCamera  = document.getElementById('ctrl-camera');
const bottomBar   = document.getElementById('bottom-bar');
const pageInd     = document.getElementById('page-indicator');
const btnMode     = document.getElementById('btn-mode');

/* =========================================================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
========================================================= */
function save() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  catch(e) { alert('ä¿å­˜å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚'); }
}

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const parsed = JSON.parse(raw);
    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¤œè¨¼
    if (!Array.isArray(parsed.photos)) return false;
    data = parsed;
    return data.photos.length > 0;
  } catch(e) {
    localStorage.removeItem(STORAGE_KEY);
    return false;
  }
}

/* =========================================================
   èµ·å‹•
========================================================= */
function init() {
  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å°å°
  document.addEventListener('contextmenu', e => e.preventDefault());

  if (load()) {
    data.currentIndex = data.photos.length - 1;
    showPhoto();
  } else {
    data = { photos: [], currentIndex: -1 };
    openCamera();
  }
}

/* =========================================================
   ã‚«ãƒ¡ãƒ©
========================================================= */
async function openCamera() {
  layerPhoto.style.display = 'none';
  layerTouch.style.display = 'none';
  bottomBar.style.display  = 'none';
  layerVideo.style.display = 'block';
  ctrlCamera.style.display = 'flex';
  hTitle.textContent = 'ğŸ“¸ æ’®å½±ãƒ¢ãƒ¼ãƒ‰';
  hSub.textContent   = 'å•†å“æ£šã‚’æ­£é¢ã‹ã‚‰æ’®å½±ã—ã¦ãã ã•ã„';

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    });
    layerVideo.srcObject = stream;
  } catch(e) {
    alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }
}

function stopCamera() {
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  layerVideo.style.display = 'none';
  layerVideo.srcObject = null;
  ctrlCamera.style.display = 'none';
}

document.getElementById('btn-shutter').addEventListener('click', () => {
  const MAX = 1280;
  let w = layerVideo.videoWidth  || 640;
  let h = layerVideo.videoHeight || 480;
  if (w > MAX || h > MAX) {
    if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
    else       { w = Math.round(w * MAX / h); h = MAX; }
  }
  const cv = document.createElement('canvas');
  cv.width = w; cv.height = h;
  cv.getContext('2d').drawImage(layerVideo, 0, 0, w, h);
  const img64 = cv.toDataURL('image/jpeg', 0.82);

  data.photos.push({ id: Date.now(), image: img64, badges: [] });
  data.currentIndex = data.photos.length - 1;
  save();
  stopCamera();
  showPhoto();
});

document.getElementById('btn-cancel').addEventListener('click', () => {
  if (data.photos.length > 0) { stopCamera(); showPhoto(); }
  else { alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ’®å½±ã—ã¦ãã ã•ã„ã€‚'); }
});

/* =========================================================
   å†™çœŸè¡¨ç¤º
========================================================= */
function showPhoto() {
  const photo = data.photos[data.currentIndex];
  layerTouch.innerHTML = '';

  layerPhoto.src = photo.image;
  layerPhoto.style.display = 'block';
  layerTouch.style.display = 'block';
  bottomBar.style.display  = 'flex';

  pageInd.textContent = `${data.currentIndex + 1} / ${data.photos.length}`;
  updateHeader();
  photo.badges.forEach(b => mountBadge(b));
}

function updateHeader() {
  if (isCheckMode) {
    hTitle.textContent = 'ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰';
    hSub.textContent   = 'ã‚¿ãƒƒãƒ—ã§âœ“ / é•·æŠ¼ã—ã§å‰Šé™¤';
  } else {
    hTitle.textContent = 'ğŸ“ ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰';
    hSub.textContent   = 'ã‚¿ãƒƒãƒ—ã§ã‚«ã‚¦ãƒ³ãƒˆUP / é•·æŠ¼ã—ã§å‰Šé™¤';
  }
}

/* =========================================================
   ãƒšãƒ¼ã‚¸é€ã‚Š
========================================================= */
document.getElementById('btn-prev').addEventListener('click', () => {
  if (data.currentIndex > 0) { data.currentIndex--; showPhoto(); }
});
document.getElementById('btn-next').addEventListener('click', () => {
  if (data.currentIndex < data.photos.length - 1) { data.currentIndex++; showPhoto(); }
});
document.getElementById('btn-add-photo').addEventListener('click', openCamera);

document.getElementById('btn-reset').addEventListener('click', () => {
  if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
    localStorage.removeItem(STORAGE_KEY);
    data = { photos: [], currentIndex: -1 };
    openCamera();
  }
});

/* =========================================================
   ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
========================================================= */
btnMode.addEventListener('click', () => {
  isCheckMode = !isCheckMode;
  btnMode.className = isCheckMode ? 'btn btn-green' : 'btn btn-white';
  btnMode.textContent = isCheckMode ? 'âœ… ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ã¸æˆ»ã‚‹' : 'ğŸ“¦ æ¶ˆè¾¼ãƒ¢ãƒ¼ãƒ‰ã¸';
  updateHeader();
  // æ¶ˆè¾¼çŠ¶æ…‹ã‚’UIã«åæ˜ 
  document.querySelectorAll('.badge').forEach(el => {
    const id = Number(el.dataset.id);
    const photo = data.photos[data.currentIndex];
    const b = photo.badges.find(x => x.id === id);
    if (b) {
      el.classList.toggle('checked', !!b.checked);
      el.textContent = b.checked ? 'âœ“' : b.count;
    }
  });
});

/* =========================================================
   ãƒãƒƒã‚¸è¨­ç½®ï¼ˆtouchAreaã‚¿ãƒƒãƒ—ï¼‰
   ãƒã‚¤ãƒ³ãƒˆï¼štouchend ã§åº§æ¨™ã‚’å–å¾—ã—ã€clickã¯ä½¿ã‚ãªã„
========================================================= */
let touchStartPos = null;

layerTouch.addEventListener('touchstart', e => {
  if (e.target !== layerTouch) return;
  touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
}, { passive: true });

layerTouch.addEventListener('touchend', e => {
  if (isCheckMode || e.target !== layerTouch || !touchStartPos) return;

  const t = e.changedTouches[0];
  const dx = t.clientX - touchStartPos.x;
  const dy = t.clientY - touchStartPos.y;
  // ã‚¹ãƒ¯ã‚¤ãƒ—åˆ¤å®šï¼ˆ10pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã‚¿ãƒƒãƒ—æ‰±ã„ã—ãªã„ï¼‰
  if (Math.sqrt(dx*dx + dy*dy) > 10) return;

  const x = t.clientX, y = t.clientY;
  const photo = data.photos[data.currentIndex];

  // é‡ãªã‚Šé˜²æ­¢
  const tooClose = photo.badges.some(b => Math.hypot(b.x - x, b.y - y) < MIN_DIST);
  if (tooClose) return;

  const badge = { id: Date.now(), x, y, count: 1, checked: false };
  photo.badges.push(badge);
  save();
  mountBadge(badge);
}, { passive: true });

// PCãƒã‚¦ã‚¹ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
layerTouch.addEventListener('click', e => {
  if (isCheckMode || e.target !== layerTouch) return;
  if (touchStartPos) return; // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã¯touchendã§å‡¦ç†æ¸ˆã¿

  const photo = data.photos[data.currentIndex];
  const tooClose = photo.badges.some(b => Math.hypot(b.x - e.clientX, b.y - e.clientY) < MIN_DIST);
  if (tooClose) return;

  const badge = { id: Date.now(), x: e.clientX, y: e.clientY, count: 1, checked: false };
  photo.badges.push(badge);
  save();
  mountBadge(badge);
});

/* =========================================================
   ãƒãƒƒã‚¸DOMç”Ÿæˆ
========================================================= */
function mountBadge(badgeData) {
  const el = document.createElement('div');
  el.className   = `badge ${badgeData.checked ? 'checked' : ''}`;
  el.dataset.id  = badgeData.id;
  el.style.left  = badgeData.x + 'px';
  el.style.top   = badgeData.y + 'px';
  el.textContent = badgeData.checked ? 'âœ“' : badgeData.count;

  /* --- é•·æŠ¼ã—å‰Šé™¤ --- */
  let pressTimer   = null;
  let moved        = false;
  let touchStarted = false;

  function startLongPress() {
    moved = false;
    pressTimer = setTimeout(() => {
      if (!moved && confirm('ã“ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        const photo = data.photos[data.currentIndex];
        photo.badges = photo.badges.filter(b => b.id !== badgeData.id);
        save();
        el.remove();
      }
    }, 600);
  }
  function cancelLongPress() { clearTimeout(pressTimer); pressTimer = null; }

  el.addEventListener('touchstart', e => {
    e.stopPropagation();
    touchStarted = true;
    el.classList.add('active');
    startLongPress();
  }, { passive: true });

  el.addEventListener('touchmove', () => {
    moved = true;
    cancelLongPress();
  }, { passive: true });

  el.addEventListener('touchend', e => {
    e.stopPropagation();
    el.classList.remove('active');
    if (pressTimer) {
      // é•·æŠ¼ã—ã§ã¯ãªã‹ã£ãŸ â†’ ã‚¿ãƒƒãƒ—å‡¦ç†
      cancelLongPress();
      handleBadgeTap(badgeData, el);
    }
    touchStarted = false;
  }, { passive: true });

  // ãƒã‚¦ã‚¹ç”¨
  el.addEventListener('mousedown', e => {
    if (touchStarted) return;
    e.stopPropagation();
    startLongPress();
  });
  el.addEventListener('mouseup', e => {
    if (touchStarted) return;
    e.stopPropagation();
    if (pressTimer) { cancelLongPress(); handleBadgeTap(badgeData, el); }
  });
  el.addEventListener('mouseleave', () => { if (!touchStarted) cancelLongPress(); });

  layerTouch.appendChild(el);
}

function handleBadgeTap(badgeData, el) {
  const photo = data.photos[data.currentIndex];
  const target = photo.badges.find(b => b.id === badgeData.id);
  if (!target) return;

  if (isCheckMode) {
    target.checked = !target.checked;
    el.classList.toggle('checked', target.checked);
    el.textContent = target.checked ? 'âœ“' : target.count;
  } else {
    target.count = target.count >= 7 ? 1 : target.count + 1;
    el.textContent = target.count;
  }
  save();
}

/* =========================================================
   èµ·å‹•
========================================================= */
init();
</script>
</body>
</html>
